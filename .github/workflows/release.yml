name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest

    steps:
      - name: Check CI status for commit
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Skip CI verification for pre-releases (beta, alpha, rc)
          if [[ "${{ github.ref }}" =~ (alpha|beta|rc) ]]; then
            echo "⏭️ Skipping CI verification for pre-release"
            exit 0
          fi

          echo "Checking CI status for commit ${{ github.sha }}..."

          # Wait up to 5 minutes for CI to complete (in case it's still running)
          for i in {1..30}; do
            # Get CI workflow runs for this commit
            CI_RUN=$(gh run list \
              --repo ${{ github.repository }} \
              --commit ${{ github.sha }} \
              --workflow ci.yml \
              --json status,conclusion \
              --jq '.[0]' 2>/dev/null || echo '{}')

            STATUS=$(echo "$CI_RUN" | jq -r '.status // "not_found"')
            CONCLUSION=$(echo "$CI_RUN" | jq -r '.conclusion // "pending"')

            echo "Attempt $i: status=$STATUS, conclusion=$CONCLUSION"

            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "✅ CI passed for commit ${{ github.sha }}"
                exit 0
              else
                echo "❌ CI failed for commit ${{ github.sha }} (conclusion: $CONCLUSION)"
                exit 1
              fi
            fi

            if [ "$STATUS" = "not_found" ]; then
              echo "⏳ No CI run found yet, waiting..."
            else
              echo "⏳ CI still running ($STATUS), waiting..."
            fi

            sleep 10
          done

          echo "❌ Timeout waiting for CI to complete"
          exit 1

  build-and-release:
    name: Build and Release
    runs-on: macos-15
    needs: verify-ci

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Import signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Allow codesign to access keychain without prompts
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add to search list (prepend to existing)
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          # Find signing identity
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Developer ID Application" | head -1 | awk -F'"' '{print $2}')
          if [ -z "$IDENTITY" ]; then
            echo "❌ No Developer ID Application certificate found"
            exit 1
          fi
          echo "✅ Found signing identity: $IDENTITY"

          # Export for subsequent steps
          echo "SIGNING_IDENTITY=$IDENTITY" >> $GITHUB_ENV
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build release
        run: make build-release

      - name: Create app bundle
        run: |
          mkdir -p TermQ.app/Contents/MacOS
          mkdir -p TermQ.app/Contents/Resources
          cp .build/release/TermQ TermQ.app/Contents/MacOS/TermQ
          cp .build/release/termqcli TermQ.app/Contents/Resources/termqcli
          cp .build/release/termqmcp TermQ.app/Contents/Resources/termqmcp
          # Copy localization resources bundle
          if [ -d ".build/release/TermQ_TermQ.bundle" ]; then
            cp -R .build/release/TermQ_TermQ.bundle TermQ.app/Contents/Resources/
          fi
          if [ -f AppIcon.icns ]; then cp AppIcon.icns TermQ.app/Contents/Resources/AppIcon.icns; fi

          # Create Info.plist with version info
          cp Info.plist.template TermQ.app/Contents/Info.plist
          plutil -replace CFBundleShortVersionString -string "${{ steps.version.outputs.VERSION }}" TermQ.app/Contents/Info.plist
          plutil -replace CFBundleVersion -string "$(git rev-parse --short=7 HEAD)" TermQ.app/Contents/Info.plist

      - name: Sign app bundle
        run: |
          # Sign embedded binaries first (inside-out signing)
          echo "Signing termqcli..."
          codesign --force --options runtime --timestamp \
            --sign "$SIGNING_IDENTITY" \
            --keychain "$KEYCHAIN_PATH" \
            --entitlements TermQ.entitlements \
            TermQ.app/Contents/Resources/termqcli

          echo "Signing termqmcp..."
          codesign --force --options runtime --timestamp \
            --sign "$SIGNING_IDENTITY" \
            --keychain "$KEYCHAIN_PATH" \
            --entitlements TermQ.entitlements \
            TermQ.app/Contents/Resources/termqmcp

          # Sign the main app bundle
          echo "Signing TermQ.app..."
          codesign --force --options runtime --timestamp \
            --sign "$SIGNING_IDENTITY" \
            --keychain "$KEYCHAIN_PATH" \
            --entitlements TermQ.entitlements \
            TermQ.app

          # Verify signature
          echo "Verifying signature..."
          codesign --verify --deep --strict --verbose=2 TermQ.app
          echo "✅ App bundle signed successfully"

      - name: Notarize app bundle
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Create zip for notarization submission
          echo "Creating zip for notarization..."
          ditto -c -k --keepParent TermQ.app TermQ-notarize.zip

          # Submit for notarization and wait
          echo "Submitting for notarization (this may take several minutes)..."
          xcrun notarytool submit TermQ-notarize.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait \
            --timeout 30m

          # Staple the notarization ticket to the app
          echo "Stapling notarization ticket..."
          xcrun stapler staple TermQ.app

          # Verify notarization
          echo "Verifying notarization..."
          spctl --assess --type execute --verbose=2 TermQ.app

          # Cleanup
          rm TermQ-notarize.zip
          echo "✅ App notarized and stapled successfully"

      - name: Create and sign DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg-contents
          cp -R TermQ.app dmg-contents/
          ln -s /Applications dmg-contents/Applications

          # Create the DMG
          echo "Creating DMG..."
          hdiutil create -volname "TermQ" -srcfolder dmg-contents -ov -format UDZO TermQ-${{ steps.version.outputs.VERSION }}.dmg

          # Sign the DMG
          echo "Signing DMG..."
          codesign --force --timestamp \
            --sign "$SIGNING_IDENTITY" \
            --keychain "$KEYCHAIN_PATH" \
            TermQ-${{ steps.version.outputs.VERSION }}.dmg

          # Notarize the DMG
          echo "Notarizing DMG..."
          xcrun notarytool submit TermQ-${{ steps.version.outputs.VERSION }}.dmg \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait \
            --timeout 30m

          # Staple the DMG
          echo "Stapling DMG..."
          xcrun stapler staple TermQ-${{ steps.version.outputs.VERSION }}.dmg

          # Clean up
          rm -rf dmg-contents
          echo "✅ DMG created, signed, and notarized"

      - name: Create zip archive
        run: zip -r TermQ-${{ steps.version.outputs.VERSION }}.zip TermQ.app

      - name: Generate checksums
        run: |
          shasum -a 256 TermQ-${{ steps.version.outputs.VERSION }}.dmg > checksums.txt
          shasum -a 256 TermQ-${{ steps.version.outputs.VERSION }}.zip >> checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: TermQ v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            TermQ-${{ steps.version.outputs.VERSION }}.dmg
            TermQ-${{ steps.version.outputs.VERSION }}.zip
            checksums.txt
          body: |
            ## Installation

            ### macOS App (Recommended)
            1. Download `TermQ-${{ steps.version.outputs.VERSION }}.dmg`
            2. Open the DMG and drag `TermQ.app` to your Applications folder
            3. Double-click to launch

            ### Alternative: Zip Archive
            1. Download `TermQ-${{ steps.version.outputs.VERSION }}.zip`
            2. Unzip and move `TermQ.app` to your Applications folder

            ### CLI Tool
            The `termqcli` CLI is bundled inside the app. To install it:
            1. Open TermQ.app
            2. Go to **TermQ → Settings** (or press ⌘,)
            3. Click **Install Command Line Tool**

            Or manually:
            ```bash
            sudo cp /Applications/TermQ.app/Contents/Resources/termqcli /usr/local/bin/termqcli
            ```

            ## Checksums
            See `checksums.txt` for SHA-256 checksums of all release artifacts.

      - name: Cleanup keychain
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
