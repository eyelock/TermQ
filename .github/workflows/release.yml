name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest

    steps:
      - name: Check CI status for commit
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking CI status for commit ${{ github.sha }}..."

          # Wait up to 5 minutes for CI to complete (in case it's still running)
          for i in {1..30}; do
            # Get CI workflow runs for this commit
            CI_RUN=$(gh run list \
              --repo ${{ github.repository }} \
              --commit ${{ github.sha }} \
              --workflow ci.yml \
              --json status,conclusion \
              --jq '.[0]' 2>/dev/null || echo '{}')

            STATUS=$(echo "$CI_RUN" | jq -r '.status // "not_found"')
            CONCLUSION=$(echo "$CI_RUN" | jq -r '.conclusion // "pending"')

            echo "Attempt $i: status=$STATUS, conclusion=$CONCLUSION"

            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "✅ CI passed for commit ${{ github.sha }}"
                exit 0
              else
                echo "❌ CI failed for commit ${{ github.sha }} (conclusion: $CONCLUSION)"
                exit 1
              fi
            fi

            if [ "$STATUS" = "not_found" ]; then
              echo "⏳ No CI run found yet, waiting..."
            else
              echo "⏳ CI still running ($STATUS), waiting..."
            fi

            sleep 10
          done

          echo "❌ Timeout waiting for CI to complete"
          exit 1

  build-and-release:
    name: Build and Release
    runs-on: macos-15
    needs: verify-ci

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Copy Help Resources
        run: make copy-help

      - name: Build release
        run: swift build -c release

      - name: Build for testing
        run: swift build --build-tests || true

      - name: Create app bundle
        run: |
          mkdir -p TermQ.app/Contents/MacOS
          mkdir -p TermQ.app/Contents/Resources
          cp .build/release/TermQ TermQ.app/Contents/MacOS/TermQ
          cp .build/release/termq TermQ.app/Contents/Resources/termq
          cp .build/release/termqmcp TermQ.app/Contents/Resources/termqmcp
          if [ -f AppIcon.icns ]; then cp AppIcon.icns TermQ.app/Contents/Resources/AppIcon.icns; fi

          # Create Info.plist with version info
          cp Info.plist.template TermQ.app/Contents/Info.plist
          plutil -replace CFBundleShortVersionString -string "${{ steps.version.outputs.VERSION }}" TermQ.app/Contents/Info.plist
          plutil -replace CFBundleVersion -string "$(git rev-parse --short=7 HEAD)" TermQ.app/Contents/Info.plist

      - name: Sign app bundle
        run: codesign --force --deep --sign - --entitlements TermQ.entitlements TermQ.app

      - name: Create DMG
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg-contents
          cp -R TermQ.app dmg-contents/
          ln -s /Applications dmg-contents/Applications

          # Create the DMG
          hdiutil create -volname "TermQ" -srcfolder dmg-contents -ov -format UDZO TermQ-${{ steps.version.outputs.VERSION }}.dmg

          # Clean up
          rm -rf dmg-contents

      - name: Create zip archive
        run: zip -r TermQ-${{ steps.version.outputs.VERSION }}.zip TermQ.app

      - name: Generate checksums
        run: |
          shasum -a 256 TermQ-${{ steps.version.outputs.VERSION }}.dmg > checksums.txt
          shasum -a 256 TermQ-${{ steps.version.outputs.VERSION }}.zip >> checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: TermQ v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            TermQ-${{ steps.version.outputs.VERSION }}.dmg
            TermQ-${{ steps.version.outputs.VERSION }}.zip
            checksums.txt
          body: |
            ## Installation

            ### macOS App (Recommended)
            1. Download `TermQ-${{ steps.version.outputs.VERSION }}.dmg`
            2. Open the DMG and drag `TermQ.app` to your Applications folder
            3. Right-click and select "Open" on first launch (required for unsigned apps)

            ### Alternative: Zip Archive
            1. Download `TermQ-${{ steps.version.outputs.VERSION }}.zip`
            2. Unzip and move `TermQ.app` to your Applications folder

            ### CLI Tool
            The `termq` CLI is bundled inside the app. To install it:
            1. Open TermQ.app
            2. Go to **TermQ → Settings** (or press ⌘,)
            3. Click **Install Command Line Tool**

            Or manually:
            ```bash
            sudo cp /Applications/TermQ.app/Contents/Resources/termq /usr/local/bin/
            ```

            ## Checksums
            See `checksums.txt` for SHA-256 checksums of all release artifacts.
